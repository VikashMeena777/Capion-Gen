name: Caption Video Pipeline

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct download URL of the video to caption'
        required: true
        type: string
      highlight_color:
        description: 'Active word highlight color (hex)'
        required: false
        default: '#FFD700'
        type: string
      font_size:
        description: 'Caption font size in pixels'
        required: false
        default: '90'
        type: string
      caption_y_position:
        description: 'Caption vertical position (0-100%)'
        required: false
        default: '72'
        type: string
      max_words_per_page:
        description: 'Max words per caption page (2-3 recommended)'
        required: false
        default: '3'
        type: string
      bg_opacity:
        description: 'Caption background pill opacity (0-1)'
        required: false
        default: '0.6'
        type: string
      enhance_captions:
        description: 'Use AI to fix Whisper errors (requires GROQ_API_KEY secret)'
        required: false
        default: 'true'
        type: string

jobs:
  caption-video:
    name: Transcribe and Render Captions
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Download input video
        run: |
          VIDEO_URL="${{ inputs.video_url }}"
          
          # Check if it's a Google Drive link and extract file ID
          if echo "$VIDEO_URL" | grep -q "drive.google.com"; then
            FILE_ID=$(echo "$VIDEO_URL" | grep -oP '(?<=/d/|id=)[^/&]+')
            echo "Detected Google Drive link, file ID: $FILE_ID"
            pip install gdown
            gdown "https://drive.google.com/uc?id=$FILE_ID" -O input.mp4
          else
            curl -L -o input.mp4 "$VIDEO_URL"
          fi
          
          ls -lh input.mp4
          file input.mp4
          echo "Video downloaded: $(du -h input.mp4 | cut -f1)"

      - name: Extract audio from video
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg
          ffmpeg -i input.mp4 -vn -acodec pcm_s16le -ar 16000 -ac 1 audio.wav -y
          echo "Audio extracted: $(du -h audio.wav | cut -f1)"

      - name: Install whisper dependencies
        run: |
          pip install transformers torch torchaudio requests
          echo "transformers + whisper installed"

      - name: Transcribe with Whisper (Hinglish)
        run: |
          python scripts/transcribe.py audio.wav \
            --model oriserve/whisper-hindi2hinglish-apex \
            --output captions.json
          echo "Captions preview:"
          head -c 500 captions.json

      - name: Enhance captions with AI
        if: ${{ inputs.enhance_captions == 'true' }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if [ -n "$GROQ_API_KEY" ]; then
            python scripts/enhance_captions.py captions.json --output captions.json
          else
            echo "No GROQ_API_KEY secret set, skipping AI enhancement"
          fi

      - name: Install Remotion dependencies
        working-directory: remotion-captions
        run: npm install --legacy-peer-deps

      - name: Prepare render props
        working-directory: remotion-captions
        env:
          HIGHLIGHT_COLOR: ${{ inputs.highlight_color }}
          FONT_SIZE: ${{ inputs.font_size }}
          CAPTION_Y_POSITION: ${{ inputs.caption_y_position }}
          MAX_WORDS_PER_PAGE: ${{ inputs.max_words_per_page }}
          BG_OPACITY: ${{ inputs.bg_opacity }}
        run: |
          mkdir -p public
          cp ../input.mp4 public/input.mp4
          cp ../captions.json captions.json
          node scripts/prepare-render.mjs public/input.mp4 captions.json inputProps.json

          # Debug: verify critical props are set
          echo "--- inputProps summary ---"
          node -e "
            const p = JSON.parse(require('fs').readFileSync('inputProps.json','utf8'));
            console.log('videoSrc:', p.videoSrc);
            console.log('durationInFrames:', p.durationInFrames);
            console.log('videoWidth:', p.videoWidth, 'videoHeight:', p.videoHeight);
            console.log('captions count:', p.captions?.length);
            if (p.captions?.length > 0) {
              console.log('first caption:', JSON.stringify(p.captions[0]));
              console.log('last caption:', JSON.stringify(p.captions[p.captions.length-1]));
            }
          "

      - name: Render captioned video
        working-directory: remotion-captions
        run: |
          npx remotion render CaptionedVideo output.mp4 \
            --props=./inputProps.json \
            --codec=h264 \
            --crf=18 \
            --log=verbose \
            --timeout=120000
          
          echo "Render complete: $(du -h output.mp4 | cut -f1)"
          
          # Verify output duration
          ffprobe -v quiet -show_entries format=duration -of csv=p=0 output.mp4 | \
            xargs -I {} echo "Output video duration: {}s"

      - name: Install rclone
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: Upload to Google Drive
        env:
          RCLONE_CONFIG_B64: ${{ secrets.RCLONE_CONFIG_B64 }}
          GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
        run: |
          python scripts/upload_gdrive.py remotion-captions/output.mp4 "$GDRIVE_FOLDER_ID"

      - name: Upload as GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: captioned-video-${{ github.run_id }}
          path: remotion-captions/output.mp4
          retention-days: 7

      - name: Upload captions JSON
        uses: actions/upload-artifact@v4
        with:
          name: captions-json-${{ github.run_id }}
          path: captions.json
          retention-days: 7

      - name: Pipeline Summary
        run: |
          echo "## Caption Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Highlight Color | \`${{ inputs.highlight_color }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Font Size | ${{ inputs.font_size }}px |" >> $GITHUB_STEP_SUMMARY
          echo "| Caption Position | ${{ inputs.caption_y_position }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Words/Page | ${{ inputs.max_words_per_page }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Enhanced | ${{ inputs.enhance_captions }} |" >> $GITHUB_STEP_SUMMARY
