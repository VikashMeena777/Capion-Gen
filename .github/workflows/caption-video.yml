name: ðŸŽ¬ Caption Video Pipeline

on:
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Direct download URL of the video to caption'
        required: true
        type: string
      highlight_color:
        description: 'Active word highlight color (hex)'
        required: false
        default: '#FFD700'
        type: string
      font_size:
        description: 'Caption font size in pixels'
        required: false
        default: '90'
        type: string
      caption_y_position:
        description: 'Caption vertical position (0-100%)'
        required: false
        default: '72'
        type: string
      max_words_per_page:
        description: 'Max words per caption page (2-3 recommended)'
        required: false
        default: '3'
        type: string
      bg_opacity:
        description: 'Caption background pill opacity (0-1)'
        required: false
        default: '0.6'
        type: string
      enhance_captions:
        description: 'Use AI to fix Whisper errors (requires GROQ_API_KEY secret)'
        required: false
        default: 'true'
        type: string
      gdrive_folder_id:
        description: 'Google Drive folder ID for output upload'
        required: false
        default: ''
        type: string

jobs:
  caption-video:
    name: ðŸŽ™ï¸ Transcribe & Render Captions
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # â”€â”€â”€ Setup â”€â”€â”€
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4

      - name: ðŸŸ¢ Setup Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: remotion-captions/package-lock.json

      - name: ðŸ Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      # â”€â”€â”€ Download Video â”€â”€â”€
      - name: ðŸ“¥ Download input video
        run: |
          echo "â¬‡ï¸ Downloading video..."
          curl -L -o input.mp4 "${{ inputs.video_url }}"
          ls -lh input.mp4
          echo "âœ… Video downloaded: $(du -h input.mp4 | cut -f1)"

      # â”€â”€â”€ Extract Audio â”€â”€â”€
      - name: ðŸ”Š Extract audio from video
        run: |
          sudo apt-get update -qq && sudo apt-get install -y -qq ffmpeg
          ffmpeg -i input.mp4 -vn -acodec pcm_s16le -ar 16000 -ac 1 audio.wav -y
          echo "âœ… Audio extracted: $(du -h audio.wav | cut -f1)"

      # â”€â”€â”€ Whisper Transcription â”€â”€â”€
      - name: ðŸ§  Install faster-whisper
        run: |
          pip install faster-whisper requests
          echo "âœ… faster-whisper installed"

      - name: ðŸŽ™ï¸ Transcribe with Whisper (Hinglish)
        run: |
          python scripts/transcribe.py audio.wav \
            --model large-v3 \
            --output captions.json
          echo "ðŸ“ Captions preview:"
          head -c 500 captions.json

      # â”€â”€â”€ AI Enhancement (Optional) â”€â”€â”€
      - name: âœ¨ Enhance captions with AI
        if: ${{ inputs.enhance_captions == 'true' }}
        env:
          GROQ_API_KEY: ${{ secrets.GROQ_API_KEY }}
        run: |
          if [ -n "$GROQ_API_KEY" ]; then
            python scripts/enhance_captions.py captions.json --output captions.json
          else
            echo "âš ï¸ No GROQ_API_KEY secret set, skipping AI enhancement"
          fi

      # â”€â”€â”€ Remotion Render â”€â”€â”€
      - name: ðŸ“¦ Install Remotion dependencies
        working-directory: remotion-captions
        run: npm ci

      - name: ðŸ”§ Prepare render props
        working-directory: remotion-captions
        env:
          HIGHLIGHT_COLOR: ${{ inputs.highlight_color }}
          FONT_SIZE: ${{ inputs.font_size }}
          CAPTION_Y_POSITION: ${{ inputs.caption_y_position }}
          MAX_WORDS_PER_PAGE: ${{ inputs.max_words_per_page }}
          BG_OPACITY: ${{ inputs.bg_opacity }}
        run: |
          # Copy files into remotion workspace
          cp ../input.mp4 public/input.mp4
          cp ../captions.json captions.json
          node scripts/prepare-render.mjs public/input.mp4 captions.json inputProps.json

      - name: ðŸŽ¨ Render captioned video
        working-directory: remotion-captions
        run: |
          npx remotion render CaptionedVideo output.mp4 \
            --props="$(cat inputProps.json)" \
            --codec=h264 \
            --crf=18 \
            --log=verbose
          echo "âœ… Render complete: $(du -h output.mp4 | cut -f1)"

      # â”€â”€â”€ Upload to Google Drive via rclone â”€â”€â”€
      - name: â˜ï¸ Install rclone
        if: ${{ inputs.gdrive_folder_id != '' }}
        run: |
          curl https://rclone.org/install.sh | sudo bash
          rclone version

      - name: â˜ï¸ Upload to Google Drive (rclone)
        if: ${{ inputs.gdrive_folder_id != '' }}
        env:
          RCLONE_CONFIG_B64: ${{ secrets.RCLONE_CONFIG_B64 }}
          RCLONE_REMOTE: ${{ secrets.RCLONE_REMOTE || 'vk889900' }}
        run: |
          python scripts/upload_gdrive.py remotion-captions/output.mp4 "${{ inputs.gdrive_folder_id }}"

      # â”€â”€â”€ Upload Artifact (Backup) â”€â”€â”€
      - name: ðŸ“¦ Upload as GitHub Artifact
        uses: actions/upload-artifact@v4
        with:
          name: captioned-video-${{ github.run_id }}
          path: remotion-captions/output.mp4
          retention-days: 7

      - name: ðŸ“¦ Upload captions JSON
        uses: actions/upload-artifact@v4
        with:
          name: captions-json-${{ github.run_id }}
          path: captions.json
          retention-days: 7

      - name: ðŸŽ‰ Pipeline Summary
        run: |
          echo "## ðŸŽ¬ Caption Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Highlight Color | \`${{ inputs.highlight_color }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Font Size | ${{ inputs.font_size }}px |" >> $GITHUB_STEP_SUMMARY
          echo "| Caption Position | ${{ inputs.caption_y_position }}% |" >> $GITHUB_STEP_SUMMARY
          echo "| Max Words/Page | ${{ inputs.max_words_per_page }} |" >> $GITHUB_STEP_SUMMARY
          echo "| AI Enhanced | ${{ inputs.enhance_captions }} |" >> $GITHUB_STEP_SUMMARY
